<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1>Events</h1>
            <p>Browse and search for upcoming events</p>
        </div>
        <div id="createEventButtonContainer"></div>
    </div>
</div>

<div class="card" style="margin-bottom: 2rem;">
    <div class="card-body">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <input 
                type="text" 
                id="searchInput" 
                class="form-input" 
                placeholder="Search events..."
                style="flex: 1; min-width: 200px;"
                onkeyup="if(typeof filterEvents === 'function') filterEvents();"
            >
            <select id="statusFilter" class="form-select" style="min-width: 150px;" onchange="if(typeof filterEvents === 'function') filterEvents();">
                <option value="">All Status</option>
                <option value="approved">Approved</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
            </select>
            <select id="categoryFilter" class="form-select" style="min-width: 150px;" onchange="if(typeof filterEvents === 'function') filterEvents();">
                <option value="">All Categories</option>
            </select>
        </div>
    </div>
</div>

<div id="eventsContainer">
    <div class="empty-state">
        <div class="empty-state-icon"><i class="fas fa-calendar"></i></div>
        <div class="empty-state-message">Loading events...</div>
    </div>
</div>

<script>
// Use IIFE to create isolated scope and avoid redeclaration errors
(function() {
    'use strict';
    
    // Initialize or reuse page data
    if (!window.eventsPageData) {
        window.eventsPageData = {
            allEvents: [],
            currentFilters: {}
        };
    }
    
    // Helper to get/set events
    function getAllEvents() {
        return window.eventsPageData.allEvents;
    }
    
    function setAllEvents(events) {
        window.eventsPageData.allEvents = Array.isArray(events) ? events : [];
    }
    
    function getCurrentFilters() {
        return window.eventsPageData.currentFilters;
    }
    
    function setCurrentFilters(filters) {
        window.eventsPageData.currentFilters = filters || {};
    }
    
    // Expose functions to global scope
    window.initPage = async function() {
        // Render create button based on role
        renderCreateButton();
        await window.loadEvents();
    };
    
    function renderCreateButton() {
        const container = document.getElementById('createEventButtonContainer');
        if (!container) return;
        
        if (typeof AppState !== 'undefined' && AppState.user && 
            (AppState.user.role === 'club_representative' || AppState.user.role === 'admin')) {
            container.innerHTML = `
                <button class="btn btn-primary" onclick="if(typeof loadPage === 'function') loadPage('events/create'); else window.location.hash = 'events/create';">
                    <i class="fas fa-plus"></i> Create Event
                </button>
            `;
        } else {
            container.innerHTML = '';
        }
    }
    
    window.loadEvents = async function(filters = {}) {
        try {
            if (typeof showLoading === 'function') {
                showLoading();
            }
            setCurrentFilters(filters);
            
            if (typeof api === 'undefined') {
                throw new Error('API service not available');
            }
            
            const response = await api.getEvents(filters);
            
            if (response.success && response.data.events) {
                setAllEvents(response.data.events);
                if (typeof window.renderEvents === 'function') {
                    window.renderEvents(getAllEvents());
                }
                if (typeof window.updateCategoryFilter === 'function') {
                    window.updateCategoryFilter();
                }
            } else {
                if (typeof window.showEmptyState === 'function') {
                    window.showEmptyState();
                }
            }
        } catch (error) {
            console.error('Error loading events:', error);
            if (typeof showToast === 'function') {
                showToast('error', 'Error', 'Failed to load events.');
            }
            if (typeof window.showEmptyState === 'function') {
                window.showEmptyState();
            }
        } finally {
            if (typeof hideLoading === 'function') {
                hideLoading();
            }
        }
    };
})();

window.renderEvents = function(events) {
    const container = document.getElementById('eventsContainer');
    if (!container) {
        // Page likely changed before data finished loading; no action needed
        return;
    }
    
    if (events.length === 0) {
        showEmptyState();
        return;
    }
    
    const escapeHtml = window.escapeHtml || function(str) { 
        if (!str) return '';
        return String(str).replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'})[m]); 
    };
    const formatDate = window.formatDate || function(d) { 
        if (!d) return 'N/A';
        return new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    };
    const formatStatus = window.formatStatus || function(s) { 
        const statusMap = { 'pending': { label: 'Pending', class: 'warning' }, 'approved': { label: 'Approved', class: 'success' }, 'rejected': { label: 'Rejected', class: 'danger' }, 'cancelled': { label: 'Cancelled', class: 'secondary' } };
        const statusInfo = statusMap[s] || { label: s, class: 'primary' };
        return `<span class="badge badge-${statusInfo.class}">${statusInfo.label}</span>`;
    };
    
    container.innerHTML = `
        <div class="grid grid-3">
            ${events.map(event => `
                <div class="card" style="cursor: pointer;" onclick="if(typeof loadPage === 'function') loadPage('events/view?id=' + ${event.id || event._id}); else window.location.hash = 'events/view?id=' + ${event.id || event._id};">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.25rem;">${escapeHtml(event.title || 'Untitled Event')}</h3>
                            ${formatStatus(event.status || 'pending')}
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${escapeHtml(event.description || 'No description')}
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                            <div><i class="fas fa-calendar"></i> ${formatDate(event.date || new Date())}</div>
                            <div><i class="fas fa-map-marker-alt"></i> ${escapeHtml((event.location && event.location.name) || 'TBA')}</div>
                            <div><i class="fas fa-users"></i> ${event.registrationCount || 0} / ${event.maxSeats || 0} registered</div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
};

window.showEmptyState = function() {
    const container = document.getElementById('eventsContainer');
    if (!container) {
        return;
    }
    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-calendar"></i></div>
            <div class="empty-state-title">No Events Found</div>
            <div class="empty-state-message">Try adjusting your search or filters</div>
        </div>
    `;
};

window.updateCategoryFilter = function() {
    const events = window.eventsPageData ? window.eventsPageData.allEvents : [];
    const categories = [...new Set(events.map(e => e.category).filter(Boolean))];
    const select = document.getElementById('categoryFilter');
    if (!select) return;
    
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">All Categories</option>' + 
        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    
    if (currentValue) {
        select.value = currentValue;
    }
};

window.debounceSearch = debounce ? debounce(() => {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    
    if (!searchInput || !statusFilter || !categoryFilter) return;
    
    const search = searchInput.value;
    const status = statusFilter.value;
    const category = categoryFilter.value;
    
    const filters = {};
    if (search) filters.search = search;
    if (status) filters.status = status;
    if (category) filters.category = category;
    
    if (typeof window.loadEvents === 'function') {
        window.loadEvents(filters);
    }
}, 300) : function() {
    console.warn('debounce function not available');
};

window.filterEvents = function() {
    if (typeof window.debounceSearch === 'function') {
        window.debounceSearch();
    }
};
</script>

